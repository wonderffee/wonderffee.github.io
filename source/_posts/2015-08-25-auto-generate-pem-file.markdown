---
layout: post
title: "è‡ªåŠ¨åŒ–ç”ŸæˆAPNS PEMæ–‡ä»¶"
date: 2015-08-25 15:23
comments: true
categories: iOS, APNS
---
###ç¼˜ç”±
ç”±äºå·¥ä½œéœ€è¦ï¼Œæˆ‘éœ€è¦å¤§é‡ç”ŸæˆiOSæ¨é€æœåŠ¡ç«¯æ‰€ç”¨åˆ°çš„PEMæ–‡ä»¶ï¼Œä¸€ä¸ªä¸ªæ‰‹åŠ¨ç”Ÿæˆé‚£çœŸæ˜¯è¦çƒ¦æ­»ã€‚æ¢³ç†äº†ä¸€ä¸‹PEMæ–‡ä»¶çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œå‘ç°æ¶‰åŠåˆ°è¯ä¹¦å¯¼å‡ºã€ç”Ÿæˆä¸éªŒè¯ï¼Œè¿™æ ·çš„è¯æˆ‘è¿˜çœŸçš„åªèƒ½ä¸€ä¸ªä¸ªæ‰‹åŠ¨ç”Ÿæˆã€‚ä¸è¿‡ä»”ç»†ç ”ç©¶ï¼Œè¿˜æ˜¯å¯ä»¥æé«˜ç”Ÿæˆè‡ªåŠ¨åŒ–æ°´å¹³çš„ï¼Œæ¯”å¦‚PEMæ–‡ä»¶åæœŸç”Ÿæˆè¿‡ç¨‹çš„æŠŠP12æ–‡ä»¶è½¬æ¢æˆPEMæ–‡ä»¶ã€‚

<!--more-->

è¿™ä¸ªP12æ–‡ä»¶è½¬æ¢æˆPEMæ–‡ä»¶çš„è‡ªåŠ¨åŒ–è¿‡ç¨‹æœ‰ä¸€ä¸ªéš¾ç‚¹ï¼Œå°±æ˜¯éœ€è¦æ‰‹åŠ¨è¾“å…¥å¯†ç ï¼Œæ¢è¨€ä¹‹å°±æ˜¯æœ‰äº¤äº’çš„è¿‡ç¨‹ï¼Œå¦‚æœå†™æˆè„šæœ¬ï¼Œå¦‚æœè®©è„šæœ¬è‡ªåŠ¨äº¤äº’å‘¢ï¼Ÿä¹Ÿå°±æ˜¯æŠŠå¯†ç å†™æ­»åœ¨è„šæœ¬é‡Œï¼Œåœ¨è„šæœ¬æ‰§è¡Œæ—¶è‡ªåŠ¨è¾“å…¥å¯†ç ã€‚è¿˜çœŸè®©æˆ‘æ‰¾åˆ°äº†è§£å†³è¿™ä¸ªé—®é¢˜çš„ç¥å™¨ï¼šexpectå’Œautoexpectã€‚

çœ‹çœ‹Expectçš„ä»‹ç»ï¼šæˆ‘ä»¬é€šè¿‡Shellå¯ä»¥å®ç°ç®€å•çš„æ§åˆ¶æµåŠŸèƒ½ï¼Œå¦‚ï¼šå¾ªç¯ã€åˆ¤æ–­ç­‰ã€‚ä½†æ˜¯å¯¹äºéœ€è¦äº¤äº’çš„åœºåˆåˆ™å¿…é¡»é€šè¿‡äººå·¥æ¥å¹²é¢„ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¼šéœ€è¦å®ç°å’Œäº¤äº’ç¨‹åºå¦‚telnetæœåŠ¡å™¨ç­‰è¿›è¡Œäº¤äº’çš„åŠŸèƒ½ã€‚è€Œexpectå°±ä½¿ç”¨æ¥å®ç°è¿™ç§åŠŸèƒ½çš„å·¥å…·ã€‚

é‚£ä¹ˆautoexpectæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®é™…ä¸Šå†™expectè„šæœ¬ä»ç„¶æ˜¯æŒºçƒ¦çš„ï¼Œautoexpectæ˜¯ç”¨æ¥å½•åˆ¶ç”Ÿæˆexpectè„šæœ¬çš„ï¼Œè¿™æ ·å°±æ›´åŠ è‡ªåŠ¨åŒ–äº†ã€‚
###å®ç°
Macæœ¬èº«å¸¦æœ‰expectå·¥å…·ï¼Œè¿™å¯ä»¥é€šè¿‡expect -vçœ‹å‡ºæ¥ï¼Œä½†æ˜¯å´æ²¡æœ‰autoexpectã€‚å…¶å®æ˜¯å› ä¸ºMacå¸¦çš„è¿™ä¸ªexpectæ¯”è¾ƒç®€å•ï¼Œç”¨brew install expectå°±å¯ä»¥å®‰è£…ä¸Šå¸¦autoexpectçš„expectäº†ã€‚

æœ¬æ–‡ä¸­PEMæ–‡ä»¶çš„ç”Ÿæˆä¸»è¦å‚è€ƒäº†[ã€ŠIOS Push è¯ä¹¦çš„é‡æ–°ç”Ÿæˆã€‹](http://blog.csdn.net/think12/article/details/8863411) ä¸€æ–‡ï¼Œæ¶‰åŠåˆ°çš„è‡ªåŠ¨åŒ–å¯¹åº”"æŠŠä¸¤ä¸ª.p12æ–‡ä»¶è½¬æ¢æˆ.pemæ–‡ä»¶"ä¹‹åçš„è¿‡ç¨‹.

åœ¨Terminalä¸‹æ‰§è¡Œautoexpect -p -f autoGeneratePEM.expå°±å¯ä»¥å¼€å§‹è„šæœ¬çš„å½•åˆ¶äº†ï¼Œå½•åˆ¶æˆåŠŸåï¼Œç”Ÿæˆçš„autoGeneratePEM.expå°±æ˜¯ä½ éœ€è¦çš„è„šæœ¬äº†ï¼Œç¨åšä¿®æ”¹ï¼Œå°±å¯ä»¥ä½¿ç”¨äº†ã€‚

ä¸‹é¢æ˜¯æˆ‘å½•ä¸‹æ¥çš„è„šæœ¬ï¼Œç”±äºæ˜¯å½•åˆ¶çš„ï¼Œæ‰€ä»¥ä¼šæœ‰ä¸€äº›å†—ä½™ä»£ç ã€‚

å¦‚ä½•ä½¿ç”¨ï¼š    
	1. ç¡®ä¿cert.p12å’Œkey.p12åœ¨å½“å‰ç›®å½•  
	2. ä¿®æ”¹è„šæœ¬ä¸­çš„custompasswordä¸ºä¸¤ä¸ªp12æ–‡ä»¶çš„å¯¼å‡ºå¯†ç ï¼ˆè¿™é‡Œå‡è®¾ä¸¤ä¸ªæ˜¯ä¸€æ ·çš„ï¼‰ï¼Œä»¥åŠä¿®æ”¹customPemPassPhraseä¸ºä½ è‡ªå·±å®šä¹‰çš„å­—ç¬¦ä¸²ã€‚   
	3. æ‰§è¡Œè„šæœ¬æ—¶éœ€è¦bundleidå‚æ•°ï¼Œç¤ºä¾‹ï¼š./autoGeneratePEM.exp com.test.123456ï¼Œæˆ–è€…./autoGeneratePEM.exp 123456

```bash
#!/usr/bin/expect -f
#
# This Expect script was generated by autoexpect on Tue Aug 25 14:39:57 2015
# Expect and autoexpect were both written by Don Libes, NIST.


set force_conservative 0  ;# set to 1 to force conservative mode even if
			  ;# script wasn't run conservatively originally
if {$force_conservative} {
	set send_slow {1 .1}
	proc send {ignore arg} {
		sleep .1
		exp_send -s -- $arg
	}
}

set timeout -1
set bundleid [lindex $argv 0]  
spawn $env(SHELL)
match_max 100000
expect -exact "\[?1034hbash-3.2\$ "
send -- "openssl pkcs12 -clcerts -nokeys -out cert.pem -in cert.p12"
expect -exact "openssl pkcs12 -clcerts -nokeys -out cert.pem -in cert.p12"
send -- "\r"
expect -exact "Enter Import Password:"
send -- "custompassword\r"
expect -exact "bash-3.2\$ "
send -- "openssl pkcs12 -nocerts -out key.pem -in key.p12"
expect -exact "openssl pkcs12 -nocerts -out key.pem -in key.p12"
send -- "\r"
expect -exact "Enter Import Password:"
send -- "custompassword\r"
expect -exact "Enter PEM pass phrase:"
send -- "customPemPassPhrase\r"
expect -exact "Verifying - Enter PEM pass phrase:"
send -- "customPemPassPhrase\r"
expect -exact "bash-3.2\$ "
send -- "openssl rsa -in key.pem -out key.unencrypted.pem"
expect -exact "openssl rsa -in key.pem -out key.unencrypted.pem"
send -- "\r"
expect -exact "Enter pass phrase for key.pem:"
send -- "customPemPassPhrase\r"
expect -exact "bash-3.2\$ "
send -- "cat cert.pem key.unencrypted.pem > $bundleid.pem"
expect -exact "cat cert.pem key.unencrypted.pem > $bundleid.pem"
send -- "\r"
expect -exact "bash-3.2\$ "
send -- "exit\r"
expect eof


```
####å‚è€ƒï¼š

* [IOS Push è¯ä¹¦çš„é‡æ–°ç”Ÿæˆ - think12çš„ä¸“æ  - åšå®¢é¢‘é“ - CSDN.NET](http://blog.csdn.net/think12/article/details/8863411)
* [autoexpectè®©expectè„šæœ¬æ›´åŠ ç®€å•ï¼-lonelysoul011-ChinaUnixåšå®¢](http://blog.chinaunix.net/uid-23123280-id-2546035.html)
* [Where is the autoexpect command line tool on OSX Mountain Lion (10.8.5) - Ask Different](http://apple.stackexchange.com/questions/103225/where-is-the-autoexpect-command-line-tool-on-osx-mountain-lion-10-8-5)
* [Apple Push Notification Services in iOS 6 Tutorial: Part 1/2 - Ray Wenderlich](http://www.raywenderlich.com/32960/apple-push-notification-services-in-ios-6-tutorial-part-1)
* [Shellè„šæœ¬å­¦ä¹ ä¹‹expectå‘½ä»¤ - ä¸“æ³¨äºç³»ç»Ÿè¿ç»´ï¼Œç³»ç»Ÿæ¶æ„æ–¹å‘ - åšå®¢é¢‘é“ - CSDN.NET](http://blog.csdn.net/leexide/article/details/17485451)